<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Greedy Gold - Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@farcade/game-sdk@latest/dist/index.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000;
        overflow: hidden;
        touch-action: manipulation;
      }
      canvas {
        display: block;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <script>
      const config = {
        type: Phaser.AUTO,
        width: 540,
        height: 960,
        physics: {
          default: "arcade",
          arcade: {
            gravity: { y: 0 },
            debug: false,
          },
        },
        scene: { preload, create, update },
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
        },
      };

      const game = new Phaser.Game(config);

      let miner, rope, hook;
      let golds = [];
      let score = 0,
        scoreText;
      let angle = 0,
        direction = 1;
      let isDropping = false,
        isGameOver = false;
      let hookSpeed = 6;
      let hookVelocityX = 0,
        hookVelocityY = 0;
      const originalHookY = 180;
      let dropSound, grabSound;

      function preload() {
        this.load.image("background", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/background1.png");
        this.load.image("miner", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/miner1.png");
        this.load.image("rope", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/rope.png");
        this.load.image("hook", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/hook.png");
        this.load.image("gold1", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/gold1.png");
        this.load.image("gold2", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/gold2.png");
        this.load.image("gold3", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@images/images/gold3.png");
        this.load.audio("drop", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@audio/audio/drop.mp3");
        this.load.audio("grab", "https://cdn.jsdelivr.net/gh/anny-syx07/asset@audio/audio/grab.mp3");
      }

      function create() {
        this.add.image(config.width / 2, config.height / 2, "background").setDisplaySize(config.width, config.height);
        miner = this.add.image(config.width / 2, 100, "miner").setScale(0.5);
        rope = this.add
          .image(config.width / 2, 150, "rope")
          .setOrigin(0.5, 0)
          .setScale(1, 1);
        hook = this.physics.add
          .image(config.width / 2, originalHookY, "hook")
          .setDepth(1)
          .setScale(0.3);

        dropSound = this.sound.add("drop");
        grabSound = this.sound.add("grab");

        scoreText = this.add.text(20, 20, "Score: 0", { font: "28px Arial", fill: "#fff" });

        for (let i = 0; i < 15; i++) {
          const type = Phaser.Math.Between(1, 3);
          const key = "gold" + type;
          const value = type === 1 ? 100 : type === 2 ? 300 : 500;
          const gold = this.physics.add
            .image(
              Phaser.Math.Between(50, config.width - 50),
              Phaser.Math.Between(config.height * 0.3, config.height * 0.95),
              key,
            )
            .setScale(0.6)
            .setImmovable(true);
          gold.goldValue = value;
          golds.push(gold);
        }

        this.input.on("pointerdown", () => {
          if (!isDropping && !isGameOver) {
            isDropping = true;
            dropSound.play();
            window.FarcadeSDK.singlePlayer.actions.hapticFeedback();

            const rad = Phaser.Math.DegToRad(angle);
            hookVelocityX = hookSpeed * Math.sin(rad);
            hookVelocityY = hookSpeed * Math.cos(rad);
          }
        });

        window.FarcadeSDK.singlePlayer.actions.ready();
      }

      function update() {
        if (isGameOver) return;

        if (!isDropping) {
          angle += 0.5 * direction;
          if (angle > 60 || angle < -60) direction *= -1;

          const rad = Phaser.Math.DegToRad(angle);
          hook.x = config.width / 2 + 100 * Math.sin(rad);
          hook.y = originalHookY + 100 * Math.cos(rad);
          updateRope();
        } else {
          hook.x += hookVelocityX;
          hook.y += hookVelocityY;
          updateRope();

          for (let gold of golds) {
            if (gold && Phaser.Math.Distance.Between(hook.x, hook.y, gold.x, gold.y) < 40) {
              grabSound.play();
              window.FarcadeSDK.singlePlayer.actions.hapticFeedback();

              score += gold.goldValue;
              scoreText.setText("Score: " + score);
              gold.destroy();
              golds.splice(golds.indexOf(gold), 1);
              resetHook();

              if (golds.length === 0) {
                sceneNextLevel.call(this);
              }
              return;
            }
          }

          if (hook.y > config.height - 20 || hook.x < 0 || hook.x > config.width) {
            gameOver(this);
          }
        }
      }

      function updateRope() {
        const dx = hook.x - miner.x;
        const dy = hook.y - miner.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angleDeg = Phaser.Math.RadToDeg(Math.atan2(dy, dx)) - 90;

        rope.setScale(1, length / rope.height);
        rope.angle = angleDeg;
        rope.x = miner.x;
        rope.y = miner.y;
        hook.setAngle(angleDeg);
      }

      function resetHook() {
        hook.x = config.width / 2;
        hook.y = originalHookY;
        isDropping = false;
        updateRope();
      }

      function gameOver(scene) {
        isGameOver = true;
        scene.add
          .text(config.width / 2, config.height / 2, "Game Over", {
            font: "40px Arial",
            fill: "#ff0000",
          })
          .setOrigin(0.5);

        window.FarcadeSDK.singlePlayer.actions.gameOver({ score: score });
      }

      function sceneNextLevel() {
        const levelText = this.add
          .text(config.width / 2, config.height / 2, "Next Level!", {
            font: "36px Arial",
            fill: "#00ff00",
          })
          .setOrigin(0.5);

        this.time.delayedCall(1000, () => {
          levelText.destroy();
          for (let i = 0; i < 15; i++) {
            const type = Phaser.Math.Between(1, 3);
            const key = "gold" + type;
            const value = type === 1 ? 100 : type === 2 ? 300 : 500;
            const gold = this.physics.add
              .image(
                Phaser.Math.Between(50, config.width - 50),
                Phaser.Math.Between(config.height * 0.3, config.height * 0.95),
                key,
              )
              .setScale(0.6)
              .setImmovable(true);
            gold.goldValue = value;
            golds.push(gold);
          }
          isDropping = false;
          hook.x = config.width / 2;
          hook.y = originalHookY;
          updateRope();
        });
      }

      window.FarcadeSDK.on("play_again", () => {
        location.reload();
      });

      window.FarcadeSDK.on("toggle_mute", (data) => {
        const isMuted = data.isMuted;
        dropSound.setMute(isMuted);
        grabSound.setMute(isMuted);
      });
    </script>
  </body>
</html>
