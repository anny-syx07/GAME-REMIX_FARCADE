<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Greedy Gold - Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@farcade/game-sdk@latest/dist/index.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000;
        overflow: hidden;
        touch-action: manipulation;
      }
      canvas {
        display: block;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <script>
      const config = {
        type: Phaser.AUTO,
        width: 540,
        height: 960,
        physics: {
          default: "arcade",
          arcade: {
            gravity: { y: 0 },
            debug: false,
          },
        },
        scene: { preload, create, update },
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
        },
      };

      const game = new Phaser.Game(config);

      let miner, rope, hook;
      let golds = [];
      let score = 0,
        scoreText;
      let angle = 0,
        direction = 1;
      let isDropping = false,
        isGameOver = false;
      let hookSpeed = 2;
      let hookVelocityX = 0,
        hookVelocityY = 0;
      let timeLeft = 60,
        timerText,
        timerEvent;

      const GOLD_CONFIG = {
        gold1: { value: 10, pullSpeed: 3, hookSpeed: 6 },
        gold2: { value: 30, pullSpeed: 2, hookSpeed: 3 },
        gold3: { value: 150, pullSpeed: 1, hookSpeed: 1.5 },
      };

      let pullingGold = null;
      const originalHookY = 180;
      let dropSound, grabSound;

      function preload() {
        this.load.image(
          "background",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/background1-LUh4GcUQpIcxUOGG4WJ4gkUl0XwrIJ.png?rrYT",
        );
        this.load.image(
          "miner",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/miner-xM7sYqfnB6jxn77jRnn3xgT0It8NbP.png?ZMzH",
        );
        this.load.image(
          "rope",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/rope-5inqWnUnXm62wuuOf01JQyhCFuSU8M.png?2Uk1",
        );
        this.load.image(
          "hook",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/hook-uJ8myh0IKVYFJrf4uWQhY3yUoT5Hl1.png?7I2R",
        );
        this.load.image(
          "gold1",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/gold1-sn26zj1DeXOohsD4ejmhH9rTDx44C3.png?3CXY",
        );
        this.load.image(
          "gold2",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/gold2-8tI3OBNNUXthWkMnQ6a25x17GzlVC4.png?0TO3",
        );
        this.load.image(
          "gold3",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/gold3-KD76qqTYCZitMC9tE0kl9atZVf82ym.png?HU2x",
        );
        this.load.audio(
          "drop",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/drop-KRqj2JHrlZUmTRfU0fYZTzIkrvRckS.mp3?yxGp",
        );
        this.load.audio(
          "grab",
          "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/2da6c75e-12b9-4885-968a-321d35cbfa9d/grab-PMzAdQJ1OSxjVHpqBP3RchDf8NN1VE.mp3?iYje",
        );
      }

      function create() {
        this.add.image(config.width / 2, config.height / 2, "background").setDisplaySize(config.width, config.height);
        miner = this.add
          .image(config.width / 2, 90, "miner")
          .setScale(0.5)
          .setDepth(2);
        rope = this.add
          .image(config.width / 2, 150, "rope")
          .setOrigin(0.5, 0)
          .setScale(0.3, 1);
        hook = this.physics.add
          .image(config.width / 2, originalHookY, "hook")
          .setDepth(1)
          .setScale(0.2)
          .setCircle(20);

        dropSound = this.sound.add("drop");
        grabSound = this.sound.add("grab");

        scoreText = this.add.text(20, 20, "Score: 0", { font: "28px Arial", fill: "#fff" });
        timerText = this.add.text(config.width - 150, 20, "Time: 60", { font: "28px Arial", fill: "#fff" });

        timerEvent = this.time.addEvent({
          delay: 1000,
          callback: () => {
            timeLeft--;
            timerText.setText("Time: " + timeLeft);
            if (timeLeft <= 0) {
              gameOver(this);
            }
          },
          callbackScope: this,
          loop: true,
        });

        for (let i = 0; i < 15; i++) {
          const type = Phaser.Math.Between(1, 3);
          const key = "gold" + type;
          const { value, pullSpeed, hookSpeed } = GOLD_CONFIG[key];
          const gold = this.physics.add
            .image(
              Phaser.Math.Between(50, config.width - 50),
              Phaser.Math.Between(config.height * 0.3, config.height * 0.95),
              key,
            )
            .setScale(0.6)
            .setImmovable(true)
            .setCircle(30);

          gold.goldValue = value;
          gold.pullSpeed = pullSpeed;
          gold.hookSpeed = hookSpeed;
          golds.push(gold);

          this.physics.add.overlap(hook, gold, collectGold, null, this);
        }

        this.input.on("pointerdown", () => {
          if (!isDropping && !isGameOver && !pullingGold) {
            isDropping = true;
            dropSound.play();
            window.FarcadeSDK.singlePlayer.actions.hapticFeedback();

            const rad = Phaser.Math.DegToRad(angle);
            hookVelocityX = hookSpeed * Math.sin(rad);
            hookVelocityY = hookSpeed * Math.cos(rad);
          }
        });

        window.FarcadeSDK.singlePlayer.actions.ready();
      }

      function collectGold(hook, gold) {
        if (isDropping && !pullingGold) {
          grabSound.play();
          window.FarcadeSDK.singlePlayer.actions.hapticFeedback();
          pullingGold = gold;
          isDropping = false;
          hookSpeed = gold.hookSpeed;
        }
      }

      function update() {
        if (isGameOver) return;

        if (!isDropping && !pullingGold) {
          angle += 0.5 * direction;
          if (angle > 60 || angle < -60) direction *= -1;

          const rad = Phaser.Math.DegToRad(angle);
          hook.x = config.width / 2 + 100 * Math.sin(rad);
          hook.y = originalHookY + 100 * Math.cos(rad);
          updateRope();
        } else if (isDropping) {
          hook.x += hookVelocityX;
          hook.y += hookVelocityY;
          updateRope();

          if (hook.y > config.height - 20 || hook.x < 0 || hook.x > config.width) {
            isDropping = false;
            pullingGold = null;
            resetHook();
            hookSpeed = 2;
          }
        }

        if (pullingGold) {
          const dx = miner.x - hook.x;
          const dy = miner.y - hook.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const speed = pullingGold.pullSpeed;

          if (dist < 10) {
            grabSound.play();
            window.FarcadeSDK.singlePlayer.actions.hapticFeedback();
            score += pullingGold.goldValue;
            scoreText.setText("Score: " + score);
            pullingGold.destroy();
            const index = golds.indexOf(pullingGold);
            if (index !== -1) golds.splice(index, 1);
            pullingGold = null;
            resetHook();
            hookSpeed = 2;
            if (golds.length === 0) {
              sceneNextLevel.call(this);
            }
          } else {
            const angle = Math.atan2(dy, dx);
            hook.x += Math.cos(angle) * speed;
            hook.y += Math.sin(angle) * speed;
            pullingGold.x = hook.x;
            pullingGold.y = hook.y;
            updateRope();
          }
        }
      }

      function updateRope() {
        const dx = hook.x - miner.x;
        const dy = hook.y - miner.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angleDeg = Phaser.Math.RadToDeg(Math.atan2(dy, dx)) - 90;

        rope.setScale(rope.scaleX, length / rope.height);
        rope.angle = angleDeg;
        rope.x = miner.x;
        rope.y = miner.y;
        hook.setAngle(angleDeg);
      }

      function resetHook() {
        hook.x = config.width / 2;
        hook.y = originalHookY;
        isDropping = false;
        updateRope();
      }

      function gameOver(scene) {
        if (isGameOver) return;
        isGameOver = true;

        if (timerEvent) timerEvent.remove(false);

        scene.add
          .text(config.width / 2, config.height / 2, "Game Over", {
            font: "40px Arial",
            fill: "#ff0000",
          })
          .setOrigin(0.5);

        window.FarcadeSDK.singlePlayer.actions.gameOver({ score: score });
      }

      function sceneNextLevel() {
        const levelText = this.add
          .text(config.width / 2, config.height / 2, "Next Level!", {
            font: "36px Arial",
            fill: "#00ff00",
          })
          .setOrigin(0.5);

        this.time.delayedCall(1000, () => {
          levelText.destroy();
          for (let i = 0; i < 15; i++) {
            const type = Phaser.Math.Between(1, 3);
            const key = "gold" + type;
            const { value, pullSpeed, hookSpeed } = GOLD_CONFIG[key];
            const gold = this.physics.add
              .image(
                Phaser.Math.Between(50, config.width - 50),
                Phaser.Math.Between(config.height * 0.3, config.height * 0.95),
                key,
              )
              .setScale(0.6)
              .setImmovable(true)
              .setCircle(30);

            gold.goldValue = value;
            gold.pullSpeed = pullSpeed;
            gold.hookSpeed = hookSpeed;
            golds.push(gold);
            this.physics.add.overlap(hook, gold, collectGold, null, this);
          }
          resetHook();
          hookSpeed = 2;
        });
      }

      window.FarcadeSDK.on("play_again", () => {
        location.reload();
      });

      window.FarcadeSDK.on("toggle_mute", (data) => {
        const isMuted = data.isMuted;
        dropSound.setMute(isMuted);
        grabSound.setMute(isMuted);
      });
    </script>
  </body>
</html>
